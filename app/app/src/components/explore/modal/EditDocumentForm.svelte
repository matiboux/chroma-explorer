<script lang="ts">
import { onMount } from 'svelte'
import { ChromaClient } from 'chromadb'
import type { GetResponse } from 'chromadb'

import { stateStore } from '~/stores/stateStore'

import type { Locales } from '~/i18n'
import { i18nFactory } from '~/i18n'
export let locale: Locales | undefined = undefined
export let editable: boolean = false
const _ = i18nFactory(locale)

// Generate a random suffix for id attributes
const idSuffix = Math.random().toString(36).substring(2)

let record: GetResponse | null | undefined = undefined
let selectedMetadata: number | null = null
let lastCopiedSelector: string | null = null

let formData: {
	id: string,
	document: string,
	embedding: string,
	metadatas: Array<{ key: string, value: string, type: string, created: boolean, updated: boolean }>,
} = {
	id: '',
	document: '',
	embedding: '',
	metadatas: [],
}

async function loadRecord()
{
	const state = stateStore.get()

	if (
		!state.collection ||
		!state.selectedDocument
	)
	{
		record = null
		return
	}

	record = undefined

	try
	{
		record = await state.collection.get({
			ids: [ state.selectedDocument ],
			include: [ 'documents', 'embeddings', 'metadatas' ],
		})
	}
	catch (error: unknown)
	{
		console.error(error)
		record = null
		return
	}

	if (record && record.ids.length > 0)
	{
		formData = {
			id: record.ids[0],
			document: record.documents[0] ?? '',
			embedding: record.embeddings?.[0] ? JSON.stringify(record.embeddings[0]) : '',
			metadatas: record.metadatas?.[0]
				? Object.entries(record.metadatas[0]).map(
					([ key, value ]) => ({
						key,
						value: typeof value === 'string' ? value : JSON.stringify(value),
						type: typeof value,
						created: false,
						deleted: false,
					})
				)
				: [],
		}
	}
}

onMount(() =>
{
	loadRecord()
})

async function copyToClipboard(selector: string)
{
	lastCopiedSelector = null
	const element = document.getElementById(`record-${selector}-${idSuffix}`) as HTMLInputElement | HTMLTextAreaElement

	if (!element)
	{
		// Element not found
		return
	}

	await navigator.clipboard.writeText(element.value)
	lastCopiedSelector = selector
}

async function onSubmit()
{
	if (!editable)
	{
		console.error('Form is not editable')
		return
	}

	if (!record)
	{
		console.error('Document not found')
		return
	}

	if (formData.id !== record.ids[0])
	{
		console.error('Document ID mismatch')
		return
	}

	try
	{
		const state = stateStore.get()
		await state.collection.update({
			ids: [ formData.id ],
			documents: [ formData.document ],
			embeddings: [ JSON.parse(formData.embedding) ],
			metadatas: [ formData.metadatas.reduce(
				(acc, metadata) =>
				{
					if (!metadata.deleted)
					{
						// TODO: Use metadata type
						acc[metadata.key] = metadata.value
					}
					return acc
				},
				{},
			) ],
		})
	}
	catch (error: unknown)
	{
		console.error(error)
	}

	// Close the modal & clear documents list
	stateStore.set({
		...stateStore.get(),
		modalViewMode: null,
		documents: null,
		selectedDocument: null,
	})
}

async function onReset()
{
	loadRecord()
}

async function onAddMetadata()
{
	const newLength = formData.metadatas.push({
		key: 'new',
		value: '',
		created: true,
	})
	selectedMetadata = newLength - 1
}
</script>

<form class="record-form" on:submit|preventDefault={onSubmit} on:reset|preventDefault={onReset}>

	{#if !record}
		<p>
			<span class="icon icon-[mdi--sync] icon-align"></span>
			{_({
				en: 'Loading record...',
				fr: 'Chargement des données...',
			})}
		</p>

	{:else if record.ids.length <= 0}
		<p>
			{_({
				en: 'Record not found',
				fr: 'Données introuvables',
			})}
		</p>

	{:else}

		<div class="input-group">
			<p>
				<strong>{_({
					en: 'Document ID',
					fr: 'ID du document',
				})}</strong>{_({
					en: ':',
					fr: ' :',
				})}
				<code>{record.ids[0]}</code>
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'id'}
					on:click|preventDefault={copyToClipboard.bind(null, 'id')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'id' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</p>
			<input
				type="hidden" id={`record-id-${idSuffix}`} name="record-id"
				bind:value={formData.id} readonly={!editable}
			/>
		</div>

		<div class="input-group">
			<label for={`record-collection-${idSuffix}`}>
				{_({
					en: 'Document',
					fr: 'Document',
				})}
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'collection'}
					on:click|preventDefault={copyToClipboard.bind(null, 'collection')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'collection' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</label>
			<p class="hint">
				{_({
					en: 'Document size: {0} bytes',
					fr: 'Taille du document: {0} octets',
				}, new Blob([ formData.document ]).size)}
			</p>
			<textarea
				id={`record-collection-${idSuffix}`} name="record-collection"
				bind:value={formData.document} readonly={!editable}
			></textarea>
		</div>

		<div class="input-group">
			<label for={`record-embedding-${idSuffix}`}>
				{_({
					en: 'Embedding',
					fr: 'Vecteur',
				})}
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'embedding'}
					on:click|preventDefault={copyToClipboard.bind(null, 'embedding')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'embedding' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</label>
			<p class="hint">
				{_({
					en: 'Embedding vector size: {0}',
					fr: 'Taille du vecteur d\'embedding : {0}',
				}, record.embeddings?.[0]?.length)}
			</p>
			<input
				type="text" id={`record-embedding-${idSuffix}`} name="record-embedding"
				bind:value={formData.embedding} readonly={!editable}
			/>
		</div>

		<div class="metadata">

			<div class="input-group">

				{#if !record.metadatas?.[0] || Object.keys(record.metadatas[0]).length <= 0}
					<p class="hint">
						{_({
							en: 'No metadata',
							fr: 'Pas de métadonnées',
						})}
					</p>

				{:else}

					<!-- List of radio buttons like badges to select the metadata to show and edit -->
					<label for="record-metadata">
						{_({
							en: 'Metadata',
							fr: 'Métadonnées',
						})}
					</label>

					<div class="radio-badges">
						{#each formData.metadatas as metadata, metadataIndex}
							<div class="radio-badge">
								<input
									type="radio" name="metadata" value={metadataIndex}
									bind:group={selectedMetadata}
									id={`metadata-${metadataIndex}-${idSuffix}`}
									disabled={metadata.deleted}
								/>
								<label for={`metadata-${metadataIndex}-${idSuffix}`}>
									{#if !metadata.deleted}
										{metadata.key}
									{:else}
										<del>{metadata.key}</del>
									{/if}
								</label>
							</div>
						{/each}
						{#if editable}
							<div class="radio-badge-button" on:click={onAddMetadata}>
								<span class="icon icon-[mdi--plus] icon-align"></span>
							</div>
						{/if}
					</div>

					{#each formData.metadatas as metadata, metadataIndex}
						<div class="input-group" hidden={selectedMetadata !== metadataIndex || metadata.deleted}>
							<label for={`record-metadata-${metadataIndex}-${idSuffix}`}>
								{metadata.key}
								{#if metadata.created}
									<small>(new)</small>
								{/if}
								<button
									type="button" class="copy-button" class:copied={lastCopiedSelector === `metadata-${metadataIndex}`}
									on:click|preventDefault={copyToClipboard.bind(null, `metadata-${metadataIndex}`)}
								>
									<span class="icon icon-[mdi--content-copy] icon-align"></span>
									{lastCopiedSelector === `metadata-${metadataIndex}` ? _({
										en: 'Copied!',
										fr: 'Copié !',
									}) : _({
										en: 'Copy',
										fr: 'Copier',
									})}
								</button>
							</label>
							{#if typeof metadata.value === 'string'}
								<p class="hint">
									{_({
										en: 'Metadata value size: {0} bytes',
										fr: 'Taille de la valeur métadonnée : {0} octets',
									}, new Blob([ metadata.value ]).size)}
								</p>
							{/if}
							<textarea
								id={`record-metadata-${metadataIndex}-${idSuffix}`} name={`record-metadata-${metadataIndex}`}
								bind:value={metadata.value} readonly={!editable}
							></textarea>
							<!-- FIXME: SET METADATA FIELD TYPE -->
						</div>
					{/each}

				{/if}

			</div>

		</div>

		{#if editable}
			<div class="button-group">
				<button type="submit">
					<span class="icon icon-[mdi--content-save] icon-align"></span>
					{_({
						en: 'Save',
						fr: 'Enregistrer',
					})}
				</button>
				<button type="reset">
					{_({
						en: 'Reset',
						fr: 'Réinitialiser',
					})}
				</button>
			</div>
		{/if}

	{/if}

</form>

<style lang="scss">
.record-form {
	@apply flex flex-col gap-4;

	p {
		strong {
			@apply font-semibold;
		}

		&.hint {
			@apply text-sm text-gray-800;
		}
	}

	code {
		@apply bg-gray-100;
		@apply border border-gray-300 rounded;
		@apply px-1.5 py-0.5;
		@apply rounded;
		@apply font-mono;
	}

	.input-group {
		@apply flex flex-col gap-2;

		&[hidden] {
			@apply hidden;
		}

		label {
			@apply font-semibold;
		}

		.copy-button {
			@apply inline-block;
			@apply ml-1 px-2 py-0.5 rounded-full;
			@apply text-sm font-normal;
			@apply text-gray-600 active:text-gray-700;
			@apply bg-gray-50 hover:bg-gray-100 active:bg-gray-200;

			&.copied {
				@apply bg-green-100 active:bg-green-200;
			}
		}

		input, textarea {
			@apply bg-gray-100 w-full p-2;
			@apply border border-gray-300 rounded;
			@apply resize-y;

			&[readonly] {
				@apply bg-gray-200 text-gray-600;
				@apply outline-none;
			}
		}

		textarea {
			@apply h-32;
		}

		.radio-badges {
			@apply flex flex-wrap gap-2;

			.radio-badge {
				@apply flex items-center gap-1;

				input[type="radio"] {
					@apply sr-only;
				}

				label, &-button {
					// Badge style
					@apply inline-block bg-gray-200 px-2 py-1 rounded-full;
					@apply text-sm font-normal;
					@apply cursor-pointer;
				}

				input[type="radio"]:checked + label {
					@apply bg-blue-500 text-white;
				}

				&-button {
					@apply hover:bg-gray-300 active:bg-gray-400;
				}
			}
		}

		.input-group {
			@apply pt-1 pb-2 pl-4 border-l-2 border-gray-300;

			label {
				@apply text-sm;
			}
		}
	}

	.button-group {
		@apply flex gap-2;

		button {
			@apply px-4 py-2 bg-gray-600 text-white rounded;
			@apply transition-colors duration-200 ease-in-out;

			&:hover {
				@apply bg-gray-700;
			}

			&:active {
				@apply bg-gray-800;
			}

			&[type='submit'] {
				@apply bg-blue-600;

				&:hover {
					@apply bg-blue-700;
				}

				&:active {
					@apply bg-blue-800;
				}
			}
		}
	}
}
</style>
