<script lang="ts">
import { onMount } from 'svelte'
import { ChromaClient } from 'chromadb'
import type { GetResponse } from 'chromadb'

import { stateStore } from '~/stores/stateStore'

import type { Locales } from '~/i18n'
import { i18nFactory } from '~/i18n'
export let locale: Locales | undefined = undefined
export let editable: boolean = false
const _ = i18nFactory(locale)

// Generate a random suffix for id attributes
const idSuffix = Math.random().toString(36).substring(2)

let record: GetResponse | null | undefined = undefined
let selectedMetadata: string | null = null
let lastCopiedSelector: string | null = null

async function loadRecord()
{
	const state = stateStore.get()

	if (
		!state.collection ||
		!state.selectedDocument
	)
	{
		record = null
		return
	}

	record = undefined

	try
	{
		record = await state.collection.get({
			ids: [ state.selectedDocument ],
			include: [ 'documents', 'embeddings', 'metadatas' ],
		})
	}
	catch (error: unknown)
	{
		console.error(error)
		record = null
	}
}

onMount(() =>
{
	loadRecord()
})

async function copyToClipboard(selector: string)
{
	lastCopiedSelector = null
	const element = document.getElementById(`record-${selector}-${idSuffix}`) as HTMLInputElement | HTMLTextAreaElement

	if (!element)
	{
		// Element not found
		return
	}

	await navigator.clipboard.writeText(element.value)
	lastCopiedSelector = selector
}

async function onReset()
{
	loadRecord()
}
</script>

<form class="record-form">

	{#if !record}
		<p>
			<span class="icon icon-[mdi--sync] icon-align"></span>
			{_({
				en: 'Loading record...',
				fr: 'Chargement des données...',
			})}
		</p>

	{:else if record.ids.length <= 0}
		<p>
			{_({
				en: 'Record not found',
				fr: 'Données introuvables',
			})}
		</p>

	{:else}

		<div class="input-group">
			<p>
				<strong>{_({
					en: 'Document ID',
					fr: 'ID du document',
				})}</strong>{_({
					en: ':',
					fr: ' :',
				})}
				<code>{record.ids[0]}</code>
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'id'}
					on:click|preventDefault={copyToClipboard.bind(null, 'id')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'id' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</p>
			<input type="hidden" id={`record-id-${idSuffix}`} name="record-id" value={record.ids[0]} readonly={!editable} />
		</div>

		<div class="input-group">
			<label for={`record-collection-${idSuffix}`}>
				{_({
					en: 'Document',
					fr: 'Document',
				})}
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'collection'}
					on:click|preventDefault={copyToClipboard.bind(null, 'collection')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'collection' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</label>
			<p class="hint">
				{_({
					en: 'Document size: {0} bytes',
					fr: 'Taille du document: {0} octets',
				}, new Blob([ record.documents[0] ?? '' ]).size)}
			</p>
			<textarea id={`record-collection-${idSuffix}`} readonly={!editable}>{record.documents[0] ?? ''}</textarea>
		</div>

		<div class="input-group">
			<label for={`record-embedding-${idSuffix}`}>
				{_({
					en: 'Embedding',
					fr: 'Vecteur',
				})}
				<button
					type="button" class="copy-button" class:copied={lastCopiedSelector === 'embedding'}
					on:click|preventDefault={copyToClipboard.bind(null, 'embedding')}
				>
					<span class="icon icon-[mdi--content-copy] icon-align"></span>
					{lastCopiedSelector === 'embedding' ? _({
						en: 'Copied!',
						fr: 'Copié !',
					}) : _({
						en: 'Copy',
						fr: 'Copier',
					})}
				</button>
			</label>
			<p class="hint">
				{_({
					en: 'Embedding vector size: {0}',
					fr: 'Taille du vecteur d\'embedding : {0}',
				}, record.embeddings?.[0]?.length)}
			</p>
			<input
				type="text" id={`record-embedding-${idSuffix}`} name="record-embedding" readonly={!editable}
				value={record.embeddings?.[0] ? JSON.stringify(record.embeddings[0]) : null}
			/>
		</div>

		<div class="metadata">

			<div class="input-group">

				{#if !record.metadatas?.[0] || Object.keys(record.metadatas[0]).length <= 0}
					<p class="hint">
						{_({
							en: 'No metadata',
							fr: 'Pas de métadonnées',
						})}
					</p>

				{:else}

					<!-- List of radio buttons like badges to select the metadata to show and edit -->
					<label for="record-metadata">
						{_({
							en: 'Metadata',
							fr: 'Métadonnées',
						})}
					</label>

					<div class="radio-badges">
						{#each Object.keys(record.metadatas[0]) as key}
							<div class="radio-badge">
								<input
									type="radio" name="metadata" value={key}
									bind:group={selectedMetadata}
									id={`metadata-${key}-${idSuffix}`}
								/>
								<label for={`metadata-${key}-${idSuffix}`}>{key}</label>
							</div>
						{/each}
					</div>

					{#each Object.entries(record.metadatas[0]) as [key, value]}
						<div class="input-group" hidden={selectedMetadata !== key}>
							<label for={`record-metadata-${key}-${idSuffix}`}>
								{key}
								<button
									type="button" class="copy-button" class:copied={lastCopiedSelector === `metadata-${key}`}
									on:click|preventDefault={copyToClipboard.bind(null, `metadata-${key}`)}
								>
									<span class="icon icon-[mdi--content-copy] icon-align"></span>
									{lastCopiedSelector === `metadata-${key}` ? _({
										en: 'Copied!',
										fr: 'Copié !',
									}) : _({
										en: 'Copy',
										fr: 'Copier',
									})}
								</button>
							</label>
							{#if typeof value === 'string'}
								<p class="hint">
									{_({
										en: 'Metadata value size: {0} bytes',
										fr: 'Taille de la valeur métadonnée : {0} octets',
									}, new Blob([ value ]).size)}
								</p>
							{/if}
							<textarea id={`record-metadata-${key}-${idSuffix}`} readonly={!editable}>{value}</textarea>
						</div>
					{/each}

				{/if}

			</div>

		</div>

		{#if editable}
			<div class="button-group">
				<button type="submit">
					<span class="icon icon-[mdi--content-save] icon-align"></span>
					{_({
						en: 'Save',
						fr: 'Enregistrer',
					})}
				</button>
				<button type="reset" on:click|preventDefault={onReset}>
					{_({
						en: 'Reset',
						fr: 'Réinitialiser',
					})}
				</button>
			</div>
		{/if}

	{/if}

</form>

<style lang="scss">
.record-form {
	@apply flex flex-col gap-4;

	p {
		strong {
			@apply font-semibold;
		}

		&.hint {
			@apply text-sm text-gray-800;
		}
	}

	code {
		@apply bg-gray-100;
		@apply border border-gray-300 rounded;
		@apply px-1.5 py-0.5;
		@apply rounded;
		@apply font-mono;
	}

	.input-group {
		@apply flex flex-col gap-2;

		&[hidden] {
			@apply hidden;
		}

		label {
			@apply font-semibold;
		}

		.copy-button {
			@apply inline-block;
			@apply ml-1 px-2 py-0.5 rounded-full;
			@apply text-sm font-normal;
			@apply text-gray-600 active:text-gray-700;
			@apply bg-gray-50 hover:bg-gray-100 active:bg-gray-200;

			&.copied {
				@apply bg-green-100 active:bg-green-200;
			}
		}

		input, textarea {
			@apply bg-gray-100 w-full p-2;
			@apply border border-gray-300 rounded;
			@apply resize-y;

			&[readonly] {
				@apply bg-gray-200 text-gray-600;
				@apply outline-none;
			}
		}

		textarea {
			@apply h-32;
		}

		.radio-badges {
			@apply flex flex-wrap gap-2;

			.radio-badge {
				@apply flex items-center gap-1;

				input[type="radio"] {
					@apply sr-only;
				}

				label {
					// Badge style
					@apply inline-block bg-gray-200 px-2 py-1 rounded-full;
					@apply text-sm font-normal;
					@apply cursor-pointer;
				}

				input[type="radio"]:checked + label {
					@apply bg-blue-500 text-white;
				}
			}
		}

		.input-group {
			@apply pt-1 pb-2 pl-4 border-l-2 border-gray-300;

			label {
				@apply text-sm;
			}
		}
	}

	.button-group {
		@apply flex gap-2;

		button {
			@apply px-4 py-2 bg-gray-600 text-white rounded;
			@apply transition-colors duration-200 ease-in-out;

			&:hover {
				@apply bg-gray-700;
			}

			&:active {
				@apply bg-gray-800;
			}

			&[type='submit'] {
				@apply bg-blue-600;

				&:hover {
					@apply bg-blue-700;
				}

				&:active {
					@apply bg-blue-800;
				}
			}
		}
	}
}
</style>
